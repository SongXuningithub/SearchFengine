{% extends "base.html" %}

{% block title %}é‡‘èæœç´¢å¼•æ“ - é¦–é¡µ{% endblock %}

{% block content %}
<div class="hero">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">é‡‘èä¿¡æ¯æœç´¢å¼•æ“</h1>
            <p class="hero-subtitle">ä¸“æ³¨äºé‡‘èã€æŠ•èµ„ã€å¸‚åœºä¿¡æ¯çš„æ™ºèƒ½æœç´¢å¹³å°</p>
            
            <div class="search-box">
                <form action="/search" method="GET" class="search-form">
                    <div class="search-input-wrapper">
                        <input 
                            type="text" 
                            name="q" 
                            placeholder="æœç´¢è‚¡ç¥¨ã€åŸºé‡‘ã€æŠ•èµ„ä¿¡æ¯..." 
                            class="search-input"
                            id="searchInput"
                            autocomplete="off"
                        >
                        <button type="submit" class="search-button">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </div>
                </form>
                
                <!-- æœç´¢å»ºè®® -->
                <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
            </div>
            
            <div class="hero-features">
                <div class="feature">
                    <div class="feature-icon">ğŸ“ˆ</div>
                    <h3>å®æ—¶å¸‚åœºæ•°æ®</h3>
                    <p>è·å–æœ€æ–°çš„è‚¡ç¥¨ã€åŸºé‡‘ã€æœŸè´§å¸‚åœºä¿¡æ¯</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">ğŸ”</div>
                    <h3>æ™ºèƒ½æœç´¢</h3>
                    <p>åŸºäºBM25ç®—æ³•çš„ç²¾å‡†ç›¸å…³æ€§æ’åº</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">âš¡</div>
                    <h3>å¿«é€Ÿå“åº”</h3>
                    <p>æ¯«ç§’çº§æœç´¢å“åº”ï¼Œå®æ—¶æ›´æ–°ç´¢å¼•</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section">
    <div class="container">
        <h2 class="section-title">çƒ­é—¨å…³é”®è¯</h2>
        <div class="keywords-grid" id="popularKeywords">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<div class="section">
    <div class="container">
        <h2 class="section-title">ç³»ç»Ÿç»Ÿè®¡</h2>
        <div class="stats-grid" id="systemStats">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½çƒ­é—¨å…³é”®è¯
    loadPopularKeywords();
    
    // åŠ è½½ç³»ç»Ÿç»Ÿè®¡
    loadSystemStats();
    
    // æœç´¢å»ºè®®åŠŸèƒ½
    const searchInput = document.getElementById('searchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    
    let suggestionTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(suggestionTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchSuggestions.style.display = 'none';
            return;
        }
        
        suggestionTimeout = setTimeout(() => {
            fetchSuggestions(query);
        }, 300);
    });
    
    // ç‚¹å‡»å¤–éƒ¨éšè—å»ºè®®
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
            searchSuggestions.style.display = 'none';
        }
    });
});

function loadPopularKeywords() {
    fetch('/api/keywords?top=12')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('popularKeywords');
                container.innerHTML = data.keywords.map(item => `
                    <a href="/search?q=${encodeURIComponent(item[0])}" class="keyword-tag">
                        ${item[0]} <span class="keyword-count">${item[1]}</span>
                    </a>
                `).join('');
            }
        })
        .catch(error => {
            console.error('Error loading keywords:', error);
        });
}

function loadSystemStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.total_documents !== undefined) {
                const container = document.getElementById('systemStats');
                container.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${data.total_documents.toLocaleString()}</div>
                        <div class="stat-label">æ–‡æ¡£æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round(data.avg_document_length)}</div>
                        <div class="stat-label">å¹³å‡æ–‡æ¡£é•¿åº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.max_results}</div>
                        <div class="stat-label">æœ€å¤§ç»“æœæ•°</div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function fetchSuggestions(query) {
    fetch(`/api/suggest?q=${encodeURIComponent(query)}&limit=5`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.suggestions && data.suggestions.length > 0) {
                const container = document.getElementById('searchSuggestions');
                container.innerHTML = data.suggestions.map(suggestion => `
                    <div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">
                        ${suggestion}
                    </div>
                `).join('');
                container.style.display = 'block';
            } else {
                document.getElementById('searchSuggestions').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error fetching suggestions:', error);
        });
}

function selectSuggestion(suggestion) {
    document.getElementById('searchInput').value = suggestion;
    document.getElementById('searchSuggestions').style.display = 'none';
    document.querySelector('.search-form').submit();
}
</script>
{% endblock %} 