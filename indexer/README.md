# æœç´¢å¼•æ“ç´¢å¼•ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å€’æ’ç´¢å¼•æ„å»ºç³»ç»Ÿï¼Œæ”¯æŒåˆ†æ‰¹å¤„ç†ã€å“ˆå¸Œåˆ†ç‰‡å’Œå†…å­˜ç®¡ç†ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸš€ æ ¸å¿ƒç‰¹æ€§
- **åˆ†æ‰¹å¤„ç†**: æ”¯æŒå¤§æ‰¹é‡æ–‡æ¡£çš„åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
- **å“ˆå¸Œåˆ†ç‰‡**: ä½¿ç”¨MD5å“ˆå¸Œå°†ä¸åŒtermåˆ†ç‰‡å­˜å‚¨ï¼Œæé«˜å¹¶è¡Œæ€§èƒ½
- **å†…å­˜ç®¡ç†**: æ™ºèƒ½å†…å­˜ç®¡ç†ï¼Œå½“åˆ†ç‰‡è¾¾åˆ°é˜ˆå€¼æ—¶è‡ªåŠ¨å¸è½½åˆ°ç£ç›˜
- **BM25ç®—æ³•**: æ”¯æŒBM25è¯„åˆ†ç®—æ³•ï¼Œæä¾›æ›´å‡†ç¡®çš„æœç´¢ç»“æœ
- **å¤šç´¢å¼•ç±»å‹**: æ”¯æŒåŸºç¡€å€’æ’ç´¢å¼•å’ŒBM25ç´¢å¼•

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–
- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šçº¿ç¨‹å®‰å…¨çš„ç´¢å¼•æ“ä½œ
- **ç£ç›˜ç¼“å­˜**: æ™ºèƒ½çš„ç£ç›˜ç¼“å­˜æœºåˆ¶ï¼Œå¹³è¡¡å†…å­˜å’Œç£ç›˜ä½¿ç”¨
- **å…ƒæ•°æ®ç®¡ç†**: å®Œæ•´çš„ç´¢å¼•å…ƒæ•°æ®ç®¡ç†ï¼Œæ”¯æŒå¢é‡æ›´æ–°
- **ç»Ÿè®¡ä¿¡æ¯**: è¯¦ç»†çš„ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾¿äºæ€§èƒ½ç›‘æ§

## ç³»ç»Ÿæ¶æ„

```
indexer/
â”œâ”€â”€ inverted_index.py      # åŸºç¡€å€’æ’ç´¢å¼•æ„å»ºå™¨
â”œâ”€â”€ bm25_indexer.py       # BM25ç´¢å¼•æ„å»ºå™¨
â”œâ”€â”€ index_manager.py       # ç´¢å¼•ç®¡ç†å™¨
â”œâ”€â”€ run_indexer.py        # å‘½ä»¤è¡Œå·¥å…·
â””â”€â”€ README.md            # è¯´æ˜æ–‡æ¡£
```

### æ ¸å¿ƒç»„ä»¶

1. **InvertedIndexBuilder**: åŸºç¡€å€’æ’ç´¢å¼•æ„å»ºå™¨
   - æ”¯æŒåˆ†æ‰¹å¤„ç†æ–‡æ¡£
   - å“ˆå¸Œåˆ†ç‰‡å­˜å‚¨
   - å†…å­˜ç®¡ç†

2. **BM25IndexBuilder**: BM25ç®—æ³•ç´¢å¼•æ„å»ºå™¨
   - æ”¯æŒBM25è¯„åˆ†ç®—æ³•
   - æ–‡æ¡£é•¿åº¦ç»Ÿè®¡
   - IDFè®¡ç®—

3. **IndexManager**: ç»Ÿä¸€ç´¢å¼•ç®¡ç†å™¨
   - å¤šç´¢å¼•ç±»å‹ç®¡ç†
   - çŠ¶æ€ç›‘æ§
   - æœç´¢æ¥å£

## å®‰è£…å’Œä½¿ç”¨

### ç¯å¢ƒè¦æ±‚
- Python 3.7+
- ä¾èµ–åŒ…: `jieba`, `sqlite3`, `pickle`, `json`

### å¿«é€Ÿå¼€å§‹

1. **æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€**
```bash
python indexer/run_indexer.py status
```

2. **æ„å»ºç´¢å¼•**
```bash
# æ„å»ºæ‰€æœ‰ç´¢å¼•
python indexer/run_indexer.py build --type all

# æ„å»ºBM25ç´¢å¼•
python indexer/run_indexer.py build --type bm25 --shards 32 --batch-size 500

# æ„å»ºåŸºç¡€ç´¢å¼•
python indexer/run_indexer.py build --type basic --shards 16
```

3. **æµ‹è¯•æœç´¢**
```bash
python indexer/run_indexer.py search --query "è‚¡ç¥¨æŠ•èµ„" --type bm25 --max-results 10
```

4. **æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯**
```bash
python indexer/run_indexer.py stats --type bm25
```

5. **æŸ¥çœ‹åˆ†ç‰‡ä¿¡æ¯**
```bash
python indexer/run_indexer.py shards --type bm25
```

## é…ç½®å‚æ•°

### ç´¢å¼•æ„å»ºå‚æ•°
- `--shards`: åˆ†ç‰‡æ•°é‡ (é»˜è®¤: 16)
- `--batch-size`: æ‰¹å¤„ç†å¤§å° (é»˜è®¤: 1000)
- `--max-memory`: æœ€å¤§å†…å­˜å¤§å° (é»˜è®¤: 10000)

### æœç´¢å‚æ•°
- `--query`: æŸ¥è¯¢å­—ç¬¦ä¸²
- `--type`: ç´¢å¼•ç±»å‹ (basic/bm25)
- `--max-results`: æœ€å¤§ç»“æœæ•° (é»˜è®¤: 10)

## æ•°æ®ç»“æ„

### Posting (å€’æ’åˆ—è¡¨é¡¹)
```python
@dataclass
class Posting:
    doc_id: int          # æ–‡æ¡£ID
    positions: List[int]  # è¯åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®
    tf: int              # è¯é¢‘
```

### BM25Posting (BM25å€’æ’åˆ—è¡¨é¡¹)
```python
@dataclass
class BM25Posting:
    doc_id: int          # æ–‡æ¡£ID
    positions: List[int]  # è¯åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®
    tf: int              # è¯é¢‘
    doc_length: int      # æ–‡æ¡£é•¿åº¦
```

## æ–‡ä»¶ç»“æ„

### ç´¢å¼•æ–‡ä»¶
```
data/indexer/
â”œâ”€â”€ shard_0.pkl              # åŸºç¡€ç´¢å¼•åˆ†ç‰‡0
â”œâ”€â”€ shard_1.pkl              # åŸºç¡€ç´¢å¼•åˆ†ç‰‡1
â”œâ”€â”€ ...
â”œâ”€â”€ bm25_shard_0.pkl         # BM25ç´¢å¼•åˆ†ç‰‡0
â”œâ”€â”€ bm25_shard_1.pkl         # BM25ç´¢å¼•åˆ†ç‰‡1
â”œâ”€â”€ ...
â”œâ”€â”€ shard_0_metadata.json    # åŸºç¡€ç´¢å¼•åˆ†ç‰‡0å…ƒæ•°æ®
â”œâ”€â”€ bm25_shard_0_metadata.json # BM25ç´¢å¼•åˆ†ç‰‡0å…ƒæ•°æ®
â”œâ”€â”€ index_stats.json          # åŸºç¡€ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
â”œâ”€â”€ bm25_index_stats.json    # BM25ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
â””â”€â”€ index_status.json        # ç´¢å¼•çŠ¶æ€ä¿¡æ¯
```

## æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†
- æ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹ç®¡ç†å†…å­˜ä½¿ç”¨
- å½“å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨åˆ·æ–°åˆ°ç£ç›˜
- æ”¯æŒå†…å­˜å’Œç£ç›˜æ•°æ®çš„æ™ºèƒ½åˆå¹¶

### åˆ†ç‰‡ç­–ç•¥
- ä½¿ç”¨MD5å“ˆå¸Œå‡½æ•°è®¡ç®—åˆ†ç‰‡ID
- ç¡®ä¿termçš„å‡åŒ€åˆ†å¸ƒ
- æ”¯æŒè‡ªå®šä¹‰åˆ†ç‰‡æ•°é‡

### æ‰¹å¤„ç†ä¼˜åŒ–
- æ”¯æŒè‡ªå®šä¹‰æ‰¹å¤„ç†å¤§å°
- å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€
- æé«˜å†…å­˜ä½¿ç”¨æ•ˆç‡

## APIæ¥å£

### IndexManager ä¸»è¦æ–¹æ³•

```python
# æ„å»ºç´¢å¼•
manager.build_basic_index(num_shards=16, batch_size=1000, max_memory_size=10000)
manager.build_bm25_index(num_shards=16, batch_size=1000, max_memory_size=10000)

# æœç´¢
results = manager.search(query="è‚¡ç¥¨æŠ•èµ„", index_type="bm25", max_results=20)

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = manager.get_index_stats(index_type="bm25")

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
db_status = manager.check_database()
```

## ç›‘æ§å’Œç»´æŠ¤

### çŠ¶æ€ç›‘æ§
- æ•°æ®åº“æ–‡æ¡£æ•°é‡
- ç´¢å¼•æ„å»ºçŠ¶æ€
- åˆ†ç‰‡ä½¿ç”¨æƒ…å†µ
- å†…å­˜ä½¿ç”¨ç»Ÿè®¡

### ç»´æŠ¤æ“ä½œ
- è‡ªåŠ¨æ¸…ç†æ—§ç´¢å¼•æ–‡ä»¶
- ç´¢å¼•çŠ¶æ€å¤‡ä»½
- æ€§èƒ½ç»Ÿè®¡æ”¶é›†

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜ä¸è¶³**
   - å‡å°‘ `max_memory_size` å‚æ•°
   - å¢åŠ åˆ†ç‰‡æ•°é‡
   - å‡å°‘æ‰¹å¤„ç†å¤§å°

2. **æ„å»ºé€Ÿåº¦æ…¢**
   - å¢åŠ æ‰¹å¤„ç†å¤§å°
   - å‡å°‘åˆ†ç‰‡æ•°é‡
   - æ£€æŸ¥ç£ç›˜I/Oæ€§èƒ½

3. **æœç´¢ç»“æœä¸å‡†ç¡®**
   - æ£€æŸ¥æ–‡æœ¬é¢„å¤„ç†
   - è°ƒæ•´BM25å‚æ•°
   - éªŒè¯ç´¢å¼•å®Œæ•´æ€§

### æ—¥å¿—åˆ†æ
ç³»ç»Ÿæä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š
- ç´¢å¼•æ„å»ºè¿›åº¦
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯
- æ€§èƒ½ç»Ÿè®¡

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„ç´¢å¼•ç±»å‹
1. ç»§æ‰¿ `InvertedIndexBuilder` æˆ– `BM25IndexBuilder`
2. å®ç°è‡ªå®šä¹‰çš„è¯„åˆ†ç®—æ³•
3. åœ¨ `IndexManager` ä¸­æ³¨å†Œæ–°ç´¢å¼•ç±»å‹

### è‡ªå®šä¹‰åˆ†ç‰‡ç­–ç•¥
1. ä¿®æ”¹ `_get_shard_id` æ–¹æ³•
2. å®ç°è‡ªå®šä¹‰çš„å“ˆå¸Œå‡½æ•°
3. è°ƒæ•´åˆ†ç‰‡æ•°é‡é…ç½®

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚
